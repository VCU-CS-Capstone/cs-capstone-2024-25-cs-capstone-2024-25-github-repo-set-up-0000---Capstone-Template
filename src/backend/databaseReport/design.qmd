---
title: Capstone Database Design
author:
    - name: Wyatt Herkamp
      email: herkampwj@vcu.edu
date: last-modified
format:
    html:
        theme: cosmo
        toc: true
        embed-resources: true
        code-copy: true
---
## Document Info
This database has two separate diagrams. This is because the redcap info might be shared with other groups.

## Notes

Almost all case note related columns are nullable. This is because the data is not exackly perfect in red cap. If all attributes are null. That set of data wont be imported from Red Cap. However, I am not sure what things will be filled and what No
I am trying to make it work. When pulling from red cap if all entries in a case_note related table are null it will just not create an entry in that case.

## Participants
```{mermaid}
erDiagram
    participants ||--o| participant_health_overview : "has one or none"
    participant_health_overview ||--o{ health_overview_mobility_devices :  "Might have many"
    participants ||--|| locations : "has one"
    participants ||--|| participants_demographics : "has one"
    participants ||--o{ participant_medications : "has many"

    participants ||--o{ participant_goals : "has many"
    participants ||--o{ participant_goal_steps : "has many"
    participant_goals ||--o{ participant_goal_steps : "has many"

    participants ||--o{ case_notes : "has many"

    case_notes ||--|| locations : "has one"
    case_notes ||--o| case_notes_medication : "has one"
    case_notes ||--o{ case_notes_students : "has one"
    case_notes ||--o| case_note_faculty_and_staff : "has one"
    case_notes ||--o| case_notes_opioid_screening : "has one"
    case_notes ||--o| case_notes_fall_screening : "has one"
    case_notes ||--o| case_notes_other_screening : "has one"
    case_notes ||--o| case_notes_health_measures : "has one"
    case_notes ||--o| case_notes_health_visits : "has one"

    participants{
        i32 participant_id PK
        i32 red_cap_id
        string first_name
        string last_name
        string phone_number_one
        string phone_number_one
        string other_contact
        string program
        location i32
        string status
        string behavioral_risks_identified
        date date_care_coordination_consent_signed
        date date_home_visit_consent_signed
        date signed_up_on
        datetime added_to_db_at
        datetime last_synced_with_redcap
    }
    participant_medications{
        i32 id PK
        i32 participant_id FK
        String name
        String dosage
        String frequency
        date date_presribed "Nullable"
        date date_entered_into_system
        bool is_current "Nullable"
        date date_discontinued "Nullable"
        string comments "Nullable"
    }
    participant_goals{
        i32 id PK
        i32 participant_id FK
        string goal
        bool is_active "Nullable"
    }
    participant_goal_steps{
        i32 id PK
        i32 goal_id FK "Nullable"
        i32 participant_id FK
        string step
        i16 confidence_in_achieving "1-10, Nullable"
        date date_set "Nullable"
        date date_to_be_completed "Nullable"
        bool action_step "Nullable"
    }
    locations {
        i32 id PK
        string name
        string program
        i32 parent_location "Petersburg has multiple locations. The rest dont"
    }
    participant_health_overview {
        i32 id PK
        i32 participant_id FK
        f32 height "in inches"
        string reported_health_conditions "Nullable"
        string allergies "Nullable"
        bool has_blood_pressure_cuff "Nullable"
        bool takes_more_than_5_medications "Nullable"
    }
    health_overview_mobility_devices {
        i32 id PK
        i32 health_overview_id FK
        String mobility_device
    }
    participants_demographics {
        i32 participant_id
        i16 age "Nullable"
        string gender "Nullable"
        string Race "Nullable"
        string race_other "Nullable"
        string race_multiple "Nullable"
        string ethnicity "Nullable"
        string language "Nullable"
        bool is_veteran "Nullable"
        Array health_insurance "Nullable"
        string highest_education_level "Nullable"
    }
    case_notes {
        i32 id PK "Will not correlate with Redcap"
        i32 participant_id FK
        i32 location FK
        i16 age
        enum visit_type
        string note_by_care_giver
        date date_of_visit
    }
    case_notes_medication{
        i32 id PK
        i32 case_note_id FK

        bool has_medications_changed_since_last_visit "Nullable"
        bool new_medication_is_opioid "Nullable"
        bool confirmed_medication_list "Nullable"

        bool has_discrepancies "Nullable"
        string disrepancies "Nullable"

        string medication_adherence "Nullable"

        bool did_provide_medication_education
        string provided_medication_education "Nullable"

        bool provided_medication_list

        bool did_provide_medication_adherence_assistance "Nullable"
        string provided_medication_education "Nullable"

        bool was_pharmacy_contacted "Nullable"
        string pharmacy_contacted "Nullable"

        bool was_pcp_contacted "Nullable"
        string pcp_contacted "Nullable"
    }
    case_note_faculty_and_staff{
        i32 id PK
        i32 case_note_id FK
        i32 faculity_type_id FK "Nullable"
        string custom_faculity_type "Nullable"
        i32 faculity_with_participants "Nullable"
        i32 faculity_with_students "Nullable"
        string faculity_name "Nullable"
        string faculty_note "Nullable"
        i32 screening_tools "Nullable"
        i32 pdsa_to_address_gaps "Nullable"
        i32 total_student_time "Nullable"
    }
    case_notes_students{
        i32 id PK
        i32 case_note_id FK
        i32 student_type_id "Nullable. student_type_id or custom_student_type must not be null"
        string custom_student_type "Nullable. student_type_id or custom_student_type must not be null "
        i32 number_of_students
    }

    case_notes_opioid_screening{
        i32 id PK
        i32 case_note_id FK
        array more_to_come "// TODO Finish Mapping from redcap"
    }
    case_notes_fall_screening{
        i32 id PK
        i32 case_note_id FK
        array more_to_come "// TODO Finish Mapping from redcap"

    }
    case_notes_other_screening{
        i32 id PK
        i32 case_note_id FK
        i32 screening_id FK "Nullable  Either screening_id or custom_screening_name must not be null"
        string custom_screening_name "Nullable Either screening_id or custom_screening_name must not be null"
        string screening_notes "Nullable"
    }

    case_notes_health_visits{
        i32 id PK
        i32 case_note_id FK
        bool emergency_number_called
        bool refused_ambulance
        string reason_for_call "Nullable. Null if `emergency_number_called` is false"
        string last_see_pcp "Nullable"
        bool did_visit_hospital  "Nullable"
        string hospital_visit "Nullable"
        bool did_visit_ed  "Nullable"
        string ed_visit "Nullable"
    }
    case_notes_health_measures{
        i32 id
        i32 case_note_id FK
        i16 blood_pressure_sit_systolic "Nullable."
        i16 blood_pressure_sit_diastolic "Nullable"
        i16 blood_pressure_stand_systolic "Nullable"
        i16 blood_pressure_stand_diastolic "Nullable"
        bool glucose_taken
        i16 glucose "Nullable"
        bool gluce_taken_fasting "Nullable"
    }
```

## Non Red Cap Data

```{mermaid}
erDiagram
    users ||--o| user_authentication_password : "has one or none"
    users ||--o| user_authentication_saml : "has one or none"
    users ||--o{ appointments :"has zero or more"
    users ||--o{ user_api_tokens :"has zero or more"
    users ||--o{ user_permissions :"has zero or more"
    users ||--o{ user_roles : "User has many roles"
    user_authentication_saml }o--||saml_providers : "Saml Provider can provide many logins"
    user_roles ||--|| roles : "1:1"
    roles ||--o{ role_permissions : "1 to many"

    appointments }o--o| participants : "Has One or none."

    users{
        i32 id PK
        string first_name
        string last_name
        string email
        DateTime created_at
    }
    user_api_tokens{
        i32 id PK
        i32 user_id FK
        string token
        string created_with "Device Info App Info"
        bool revoked "Default false"
        DateTime expires_at "Nullable"
        DateTime created_at
    }
    user_permissions{
        i32 id PK
        i32 user_id FK
        string permission
        DateTime created_at
    }
    roles{
        i32 id PK
        string name
        string description "Nullable"
    }
    role_permissions{
        i32 id PK
        i32 role_id FK
        string scope
        DateTime created_at
    }
    user_roles{
        i32 id PK
        i32 user FK
        i32 role FK
    }
    user_authentication_password {
        i32 id PK
        i32 user_id FK
        String password "Nullable"
        DataTime password_last_updated
        bool requires_password_reset
        DateTime created_at
    }
    user_authentication_saml {
        i32 id PK
        i32 user_id FK
        i32 provider FK
    }
    saml_providers {
        i32 id PK
        string name
        bool is_default "If true only one can exist in the table"
    }
    appointments{
        i32 id
        DateTime scheduled_at
        i32 preferred_clinician FK "Nullable"
        i32 participant FK "Nullable. Null if new patient"
        string first_name "Null if participant is set"
        string last_name "Null if participant is set"
        string contact_number
        bool missed_appointment "Null until scheduled time is past"
        i32 seen_by FK "Null until appointment happened"
        DateTime created_at
    }

```
